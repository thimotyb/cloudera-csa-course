#### CSA TUTORIAL
# Fai partire tutto il CSA
docker-compose up -d
# per scale up flink task manager: docker-compose up -d --scale flink-taskmanager=2

### KAFKA
## Tutorial https://docs.cloudera.com/csp-ce/latest/getting-started/topics/csp-ce-sm-kafka.html#csp-ce-sm-kafka
##
docker ps -a --format '{{.ID}}\t{{.Names}}' --filter "name=kafka.(\d)" 
# Returns: bdd8ca14d6e8    cloudera-kafka-1
# Access stream messaging manager: http://localhost:9991
docker-compose exec kafka kafka-topics.sh --list --bootstrap-server localhost:9092
docker exec -it cloudera-kafka-1 /bin/bash
/opt/kafka/bin/kafka-console-producer.sh --bootstrap-server localhost:9094 --topic csce

tmux
Ctrl-B + " (shift-2)

docker exec -it cloudera-kafka-1 /bin/bash
docker exec -it cloudera-kafka-1 /bin/bash

vmstat 1 1000 | /opt/kafka/bin/kafka-console-producer.sh --bootstrap-server localhost:9094 --topic csce
/opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server localhost:9094 --topic csce --from-beginning --group my-consumer-group

# SCHEMA REGISTRY
# Access Schema Registry: http://localhost:7788/
# Create myschema

{
  "type": "record",
  "namespace": "com.cloudera.examples",
  "name": "MachineData",
  "doc": "Machine utilization metrics",
  "fields": [
    {
      "name": "timestamp",
      "doc": "Metrics timestamp",
      "type": "long"
    },
    {
      "name": "hostname",
      "doc": "Host name of the source machine",
      "type": "string"
    },
    {
      "name": "counters",
      "doc": "Machine counters",
      "type": {
        "type": "array",
        "items": {
          "type" : "record",
          "name" : "Counter",
          "fields" : [
            {
              "name": "name",
              "doc": "Name of the counter",
              "type": "string"
            },
            {
              "name": "value",
              "doc": "Value of the counter",
              "type": "long"
            },
            {
              "name": "unit",
              "doc": "Unit of the counter value",
              "type": ["string", "null"],
              "default": "null"
            }
          ]
        }
      }
    }
  ]
}

VERSION 2:
{
  "type": "record",
  "namespace": "com.cloudera.examples",
  "name": "MachineData",
  "doc": "Machine utilization metrics",
  "fields": [
    {
      "name": "timestamp",
      "doc": "Metrics timestamp",
      "type": "long"
    },
    {
      "name": "hostname",
      "doc": "Host name of the source machine",
      "type": "string"
    },
    {
      "name": "os_type",
      "doc": "OS type of the source machine",
      "type": "string",
      "default": "UNKNOWN"
    },
    {
      "name": "counters",
      "doc": "Machine counters",
      "type": {
        "type": "array",
        "items": {
          "type" : "record",
          "name" : "Counter",
          "fields" : [
            {
              "name": "name",
              "doc": "Name of the counter",
              "type": "string"
            },
            {
              "name": "value",
              "doc": "Value of the counter",
              "type": "long"
            },
            {
              "name": "unit",
              "doc": "Unit of the counter value",
              "type": ["string", "null"],
              "default": "null"
            }
          ]
        }
      }
    }
  ]
}

#### ESERCIZIO SCHEMA REGISTRY CORSO KAFKA CLASSICO
cd schema-registry-kafka-java-client
mvn -q exec:java -Dexec.mainClass=com.cloudera.examples.sr.SchemaRegistryKafkaProducer
mvn -q exec:java -Dexec.mainClass=com.cloudera.examples.sr.SchemaRegistryKafkaConsumer


########## KAFKA CONNECT
docker ps -a --format '{{.ID}}\t{{.Names}}' --filter "name=kafka.(\d)" --filter "name=postgres"

# b0b2e4824f3c    cloudera-kafka-1
# 34da86dd592c    cloudera-postgresql-1

docker exec -it cloudera-postgresql-1 /bin/bash
psql
CREATE DATABASE csce;
ALTER DATABASE csce OWNER TO smm;
\c csce
CREATE TABLE demo (Name VARCHAR ( 255 ), Role VARCHAR, Age INT);
ALTER TABLE demo OWNER to smm;
# create topic csce-connect in SMM
docker exec -it cloudera-kafka-1 /bin/bash
/opt/kafka/bin/kafka-console-producer.sh --bootstrap-server localhost:9094 --topic csce-connect
{"Name":"Jim","Role":"Developer","Age":"23"}
{"Name":"Mary","Role":"Data Engineer","Age":"42"}
{"Name":"Jane","Role":"Developer","Age":"37"}

# Create New Connector > JDBC Sink > Import Connector Configuration
# ATTENZIONE: CAMBIATO NEXUS.URL, USARE QUELLO DI QUESTO JSON, inoltre scrive in /tmp e non /data per aggirare permessi root su data

{
  "connector.class": "org.apache.nifi.kafka.connect.StatelessNiFiSinkConnector",
  "name": "sink-demo",
  "tasks.max": "1",
  "topics": "csce-connect",
  "key.converter": "org.apache.kafka.connect.storage.StringConverter",
  "value.converter": "org.apache.kafka.connect.converters.ByteArrayConverter",
  "failure.ports": "Retry from PutDatabaseRecord",
  "meta.smm.predefined.flow.name": "JDBC Sink",
  "meta.smm.predefined.flow.version": "1.0.0",
  "nexus.url": "https://repository.cloudera.com/repository/repo/",
  "extensions.directory": "/tmp/nifi-stateless-extensions",
  "working.directory": "/tmp/nifi-stateless-working",
  "parameter.JDBC Sink Parameters:Database Connection URL": "jdbc:postgresql://postgresql:5432/csce",
  "parameter.JDBC Sink Parameters:Database Driver Class Name": "org.postgresql.Driver",
  "parameter.JDBC Sink Parameters:Database Driver Location": "/opt/connect/plugin/libs/debezium-connector-postgres/postgresql-connector-java.jar",
  "parameter.JDBC Sink Parameters:Database Table Name": "demo",
  "parameter.JDBC Sink Parameters:Database Type": "PostgreSQL",
  "parameter.JDBC Sink Parameters:Database User Name": "smm",
  "parameter.JDBC Sink Parameters:Database User Password": "cloudera",
  "parameter.JDBC Sink Parameters:Kafka Message Data Format": "JSON",
  "parameter.JDBC Sink Parameters:Schema Access Strategy": "Infer Schema"
}

# in psql:
SELECT * FROM public.demo;

###############àà
# DEMO MYSQL SOURCE DEBEZIUM
##################
cd debezium-mysql-source-demo
./scripts/start-demo.sh
./scripts/insert-demo-records.sh
./scripts/consume-topic.sh

## Pulizia
docker compose down -v
curl -X DELETE http://localhost:28083/connectors/mysql-source-demo

#####################
# CLOUDERA SQL STREAM BUILDER
#####################
# Open: http://localhost:18121 , admin/admin
# Tutorial in: https://docs.cloudera.com/csp-ce/latest/getting-started/topics/csp-ce-sa-sql-stream-builder.html#csp-ce-sa-sql-stream-builder

DROP TABLE IF EXISTS orders;
CREATE TABLE  orders (
    order_id INTEGER,
    city STRING,
    street_address STRING,
    amount INTEGER,
    order_time TIMESTAMP(3),
    order_status STRING,
    WATERMARK FOR `order_time` AS order_time - INTERVAL '15' SECOND
) WITH (
    'connector' = 'faker',
    'rows-per-second' = '1',
    'fields.order_id.expression' = '#{number.numberBetween ''0'',''99999999''}',
    'fields.city.expression' = '#{Address.city}',
    'fields.street_address.expression' = '#{Address.street_address}',
    'fields.amount.expression' = '#{number.numberBetween ''0'',''100''}',
    'fields.order_time.expression' = '#{date.past ''15'',''SECONDS''}',
    'fields.order_status.expression' = '#{regexify ''(RECEIVED|PREPARING|DELIVERING|DELIVERED|CANCELED){1}''}'
);



SELECT * FROM orders;






